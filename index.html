<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´”è¡Œç¨‹è¦åŠƒ App</title>
    <!-- å°å…¥ Tailwind CSS CDNï¼Œå¯¦ç¾ç„¡éœ€å»ºæ§‹çš„æ¨£å¼ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ä½¿ç”¨ Inter å­—é«” -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* è®“å¯ç·¨è¼¯æ–‡å­—æ¡†çœ‹èµ·ä¾†åƒæ¨™é¡Œ */
        .editable-title {
            outline: none;
            border: none;
            background: transparent;
            width: 100%;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <!-- ä¸»å®¹å™¨ -->
    <div id="app" class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">
        
        <!-- 4. ä¸»é¡Œåœ–ç‰‡æ¨™é ­èˆ‡å¯ç·¨è¼¯æ–‡å­— -->
        <header id="trip-header" class="bg-cover bg-center h-48 flex items-center justify-center relative p-6 rounded-t-xl" 
                style="background-image: url('https://placehold.co/800x300/6366f1/ffffff?text=Travel+Plan+Header');">
            <div class="absolute inset-0 bg-black opacity-40"></div>
            <input type="text" id="trip-title" class="editable-title text-4xl font-extrabold text-white z-10" value="æˆ‘çš„å¤¢å¹»ä¹‹æ—…" />
            <p id="auth-status" class="text-xs text-gray-200 absolute bottom-2 right-4 z-10"></p>
        </header>

        <div class="p-6">
            <!-- 5. æ—¥æœŸåˆ†é å°èˆª (4/6~4/11) -->
            <div id="day-tabs" class="flex flex-wrap border-b border-gray-200 -mt-6">
                <!-- Tabs will be rendered here -->
            </div>

            <!-- è¡Œç¨‹å…§å®¹å€å¡Š -->
            <section class="mt-6">
                <h2 id="current-day-title" class="text-2xl font-semibold text-indigo-700 mb-4"></h2>
                
                <div id="itinerary-list" class="space-y-4">
                    <!-- è¡Œç¨‹åˆ—è¡¨å°‡åœ¨æ­¤è™•æ¸²æŸ“ -->
                </div>
                
                <button id="add-activity-btn" class="mt-6 w-full p-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition font-semibold shadow-md">
                    + æ–°å¢æ´»å‹•
                </button>
            </section>
        </div>
    </div>

    <!-- JavaScript é‚è¼¯å€å¡Š -->
    <script type="module">
        // --- 1. Firebase å°å…¥èˆ‡é…ç½® ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ** âš ï¸ é‡è¦æé†’ï¼šè«‹å°‡ä»¥ä¸‹ä½”ä½ç¬¦æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆé…ç½®ï¼**
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const FIREBASE_APP_ID = "simple-trip-itinerary"; // å›ºå®šçš„ App ID

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let tripData = {};
        let currentDay = "2024-04-06"; // é è¨­é¡¯ç¤ºç¬¬ä¸€å¤©

        // å›ºå®šçš„ 6 å€‹å¤©æ•¸ï¼Œå¾ 4/6 åˆ° 4/11
        const dayDates = [
            { date: "2024-04-06", display: "04/06" },
            { date: "2024-04-07", display: "04/07" },
            { date: "2024-04-08", display: "04/08" },
            { date: "2024-04-09", display: "04/09" },
            { date: "2024-04-10", display: "04/10" },
            { date: "2024-04-11", display: "04/11" },
        ];
        
        const initialTripData = {
            tripTitle: "æˆ‘çš„å¤¢å¹»ä¹‹æ—…",
            // åˆå§‹åŒ–æ¯å¤©çš„è¡Œç¨‹ç‚ºç©ºé™£åˆ—
            days: dayDates.reduce((acc, day) => {
                acc[day.date] = [];
                return acc;
            }, {})
        };

        // --- 2. åˆå§‹åŒ– Firebase ---
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            document.getElementById('auth-status').textContent = 'âŒ é…ç½®éŒ¯èª¤';
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
            return; // çµ‚æ­¢è…³æœ¬
        }

        // --- 3. èªè­‰èˆ‡è³‡æ–™ç›£è½ ---
        function setupAuthAndDataListener() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    document.getElementById('auth-status').textContent = `âœ… User ID: ${currentUserId.substring(0, 4)}...`;
                    setupDataListener();
                } else {
                    // åŸ·è¡ŒåŒ¿åç™»å…¥
                    signInAnonymously(auth).then(res => {
                        currentUserId = res.user.uid;
                        document.getElementById('auth-status').textContent = `âœ… User ID: ${currentUserId.substring(0, 4)}...`;
                        setupDataListener();
                    }).catch(err => {
                        document.getElementById('auth-status').textContent = 'âŒ é€£ç·šå¤±æ•—';
                        console.error("åŒ¿åç™»å…¥å¤±æ•—:", err);
                    });
                }
            });
        }

        function setupDataListener() {
            // ä½¿ç”¨å…¬é–‹è·¯å¾‘è®“æ‰€æœ‰ç·¨è¼¯è€…éƒ½èƒ½çœ‹åˆ°ç›¸åŒçš„è¡Œç¨‹
            const tripDocRef = doc(db, `artifacts/${FIREBASE_APP_ID}/public/data/itinerary`, 'tripData');

            onSnapshot(tripDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    // ç¢ºä¿è¼‰å…¥çš„è³‡æ–™çµæ§‹æ­£ç¢º
                    const data = docSnap.data();
                    tripData = { 
                        ...initialTripData, 
                        ...data,
                        days: { ...initialTripData.days, ...data.days } // ç¢ºä¿æ‰€æœ‰å¤©æ•¸çš„éµéƒ½åœ¨
                    };
                    renderAll();
                } else {
                    console.log("æ–‡æª”ä¸å­˜åœ¨ï¼Œå¯«å…¥åˆå§‹æ•¸æ“š...");
                    setDoc(tripDocRef, initialTripData).catch(e => console.error("å¯«å…¥åˆå§‹æ•¸æ“šå¤±æ•—:", e));
                }
            }, (error) => {
                console.error("Firestore ç›£è½å¤±æ•—:", error);
                document.getElementById('auth-status').textContent = `âŒ è³‡æ–™åŒæ­¥éŒ¯èª¤: ${error.message.substring(0, 20)}...`;
            });
        }

        // --- 4. è³‡æ–™æ“ä½œèˆ‡åŒæ­¥å‡½æ•¸ ---

        async function updateFirestore(newData) {
            if (!db || !currentUserId) return;
            const tripDocRef = doc(db, `artifacts/${FIREBASE_APP_ID}/public/data/itinerary`, 'tripData');
            try {
                await setDoc(tripDocRef, newData, { merge: true });
            } catch (e) {
                console.error("å¯«å…¥ Firestore å¤±æ•—:", e);
            }
        }

        // --- 5. æ¸²æŸ“å‡½æ•¸ ---
        
        function renderAll() {
            document.getElementById('trip-title').value = tripData.tripTitle;
            renderDays();
            renderActivities();
        }

        // æ¸²æŸ“æ—¥æœŸåˆ†é 
        function renderDays() {
            const tabsContainer = document.getElementById('day-tabs');
            tabsContainer.innerHTML = '';
            
            dayDates.forEach((day) => {
                const button = document.createElement('button');
                const isCurrent = day.date === currentDay;
                
                // é¡¯ç¤º Day X (MM/DD)
                const dayIndex = dayDates.findIndex(d => d.date === day.date) + 1;
                const buttonText = `Day ${dayIndex} (${day.display})`;
                
                button.textContent = buttonText;
                button.dataset.date = day.date;
                button.className = `
                    px-4 py-2 text-sm font-medium transition-colors duration-200 
                    ${isCurrent 
                        ? 'text-white bg-indigo-600 rounded-t-lg' 
                        : 'text-gray-600 hover:bg-gray-200'
                    }
                `;
                button.addEventListener('click', () => switchDay(day.date));
                tabsContainer.appendChild(button);
            });
            
            // æ›´æ–°ç›®å‰è¡Œç¨‹æ¨™é¡Œ
            document.getElementById('current-day-title').textContent = `ğŸ“… ${dayDates.find(d => d.date === currentDay)?.display || 'è¡Œç¨‹'} è¡Œç¨‹ç¸½è¦½`;
        }

        // åˆ‡æ›å¤©æ•¸
        function switchDay(date) {
            currentDay = date;
            renderAll(); // é‡æ–°æ¸²æŸ“ä¸€åˆ‡
        }

        // æ¸²æŸ“é¸å®šå¤©æ•¸çš„æ´»å‹•
        function renderActivities() {
            const list = document.getElementById('itinerary-list');
            const currentActivities = tripData.days[currentDay] || [];
            list.innerHTML = '';

            if (currentActivities.length === 0) {
                 list.innerHTML = '<p class="text-gray-500 italic p-4 text-center border rounded-lg">æœ¬æ—¥å°šç„¡æ´»å‹•ï¼Œé»æ“Šã€Œ+ æ–°å¢æ´»å‹•ã€é–‹å§‹è¦åŠƒã€‚</p>';
                 return;
            }

            // æ ¹æ“šæ™‚é–“æ’åº (ç°¡å–®æ’åº)
            const sortedActivities = [...currentActivities].sort((a, b) => a.time.localeCompare(b.time));

            sortedActivities.forEach(activity => {
                const linkIcon = activity.locationLink ? 
                    `<a href="${activity.locationLink.startsWith('http') ? activity.locationLink : 'https://' + activity.locationLink}" target="_blank" class="ml-2 text-indigo-500 hover:text-indigo-700">ğŸ”—</a>` : 
                    '';

                const div = document.createElement('div');
                div.className = 'p-4 bg-gray-50 rounded-xl border shadow-sm flex gap-4 items-start relative';
                div.innerHTML = `
                    <div class="flex-none">
                         <!-- æ™‚é–“è¼¸å…¥æ¡† -->
                        <input type="time" value="${activity.time}" data-id="${activity.id}" data-field="time" class="text-lg font-bold text-indigo-700 bg-transparent border-b-2 border-indigo-300 w-24 p-1 activity-input">
                    </div>
                    <div class="flex-1 min-w-0 space-y-1">
                        <!-- åœ°é»/æè¿°è¼¸å…¥æ¡† -->
                        <input type="text" value="${activity.description}" data-id="${activity.id}" data-field="description" class="w-full text-base font-semibold text-gray-900 bg-transparent border-b activity-input" placeholder="æ´»å‹•æè¿°/åœ°é»">
                        
                        <div class="flex items-center text-sm text-gray-500">
                           <span class="mr-2">Google é€£çµ:</span>
                            <!-- é€£çµè¼¸å…¥æ¡† -->
                            <input type="url" value="${activity.locationLink || ''}" data-id="${activity.id}" data-field="locationLink" class="flex-1 bg-transparent border-b border-dashed text-sm italic activity-input" placeholder="è²¼ä¸Š Google Maps æˆ–å…¶ä»–é€£çµ">
                            ${linkIcon}
                        </div>
                    </div>
                    <button data-id="${activity.id}" class="flex-none p-1 text-red-500 hover:bg-red-100 rounded-full remove-activity-btn absolute top-2 right-2" title="åˆªé™¤æ´»å‹•">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 6V4c0-1-1-2-2-2h-2c-1 0-2 1-2 2v2"/></svg>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        // --- 6. äº‹ä»¶ç›£è½å™¨ (Delegation æ–¹å¼è™•ç†) ---

        // ç·¨è¼¯è¡Œç¨‹æ¨™é¡Œ
        document.getElementById('trip-title').addEventListener('change', (e) => {
            const newTitle = e.target.value.trim() || "æ—…è¡Œè¦åŠƒ";
            updateFirestore({ tripTitle: newTitle });
        });

        // æ–°å¢æ´»å‹•
        document.getElementById('add-activity-btn').addEventListener('click', () => {
            const newActivity = { 
                id: crypto.randomUUID(), 
                time: "12:00", 
                description: "æ–°æ™¯é»/æ´»å‹•",
                locationLink: ""
            };
            
            const currentActivities = tripData.days[currentDay] || [];
            const newActivities = [...currentActivities, newActivity];

            // æ›´æ–° Firestore
            updateFirestore({ days: { [currentDay]: newActivities } });
        });

        // ç·¨è¼¯æ´»å‹• (æ™‚é–“ã€æè¿°ã€é€£çµ)
        document.getElementById('itinerary-list').addEventListener('change', (e) => {
            if (e.target.classList.contains('activity-input')) {
                const id = e.target.dataset.id;
                const field = e.target.dataset.field;
                const value = e.target.value.trim();
                
                const currentActivities = tripData.days[currentDay] || [];
                
                const updatedActivities = currentActivities.map(activity => {
                    if (activity.id === id) {
                        return { ...activity, [field]: value };
                    }
                    return activity;
                });
                
                // æ›´æ–° Firestore
                updateFirestore({ days: { [currentDay]: updatedActivities } });
            }
        });

        // ç§»é™¤æ´»å‹•
        document.getElementById('itinerary-list').addEventListener('click', (e) => {
            if (e.target.closest('.remove-activity-btn')) {
                const id = e.target.closest('.remove-activity-btn').dataset.id;

                const currentActivities = tripData.days[currentDay] || [];
                const newActivities = currentActivities.filter(a => a.id !== id);
                
                // æ›´æ–° Firestore
                updateFirestore({ days: { [currentDay]: newActivities } });
            }
        });

        // å•Ÿå‹• App
        setupAuthAndDataListener();

    </script>
</body>
</html>
