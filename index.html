<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>沖繩家族旅行 2026</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { background-color: #222; margin: 0; padding: 0; }
    .app-container {
      max-width: 480px;
      margin: 0 auto;
      background-color: #F9F8F4;
      height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      box-shadow: 0 0 30px rgba(0,0,0,0.5);
      overflow: visible;/* 先測試圖片是否有顯示 */
    }
    /* 背景淡圖（如果你還想保留） */
    .bg-pattern {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e');
      background-size: cover;
      background-position: center;
      opacity: 0.05;
      z-index: 0;
      pointer-events: none;
    }
    /* 封面主圖 */
    .cover-image {
      width: 100%;
      height: 280px;
      background-image: url("https://cdn.pixabay.com/photo/2017/09/25/09/37/okinawa-2333074_1280.jpg?v=1");
      background-size: cover;
      background-position: center;
      border-bottom-left-radius: 20px;
      border-bottom-right-radius: 20px;
      position: relative;
      z-index: 5;  /* 讓它蓋過背景與內容 */
    }
  </style>
</head>
<body>

<div id="app" class="app-container text-jp-text">

    <div class="bg-pattern"></div>

    <header v-if="currentTab !== 'info'" class="bg-jp-bg/95 backdrop-blur-md pt-6 pb-2 px-4 shadow-sm z-20 shrink-0 relative transition-all duration-300">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center">
                <h1 class="text-xl font-bold tracking-widest text-jp-dark-gray mr-2">
                    <span class="text-jp-blue">OKINAWA</span> <span class="text-sm font-normal">行程表</span>
                </h1>
            </div>
            <div class="text-xs bg-jp-primary text-black pl-3 pr-1 py-1 rounded-full shadow-sm flex items-center">
                匯率: <input type="number" step="0.001" v-model="exchangeRate" @change="saveData" class="w-14 bg-transparent border-b border-white/50 text-center focus:outline-none ml-1 text-black font-bold">
            </div>
        </div>

        <div class="flex space-x-3 overflow-x-auto hide-scrollbar pb-2 px-1 relative z-30">
            <button 
                v-for="(day, index) in tripDates" 
                :key="index"
                @click="selectDay(index)"
                :class="['flex-shrink-0 w-16 h-18 py-2 rounded-xl flex flex-col items-center justify-center transition-all duration-300 border', 
                currentDayIndex === index ? 'bg-jp-blue text-black border-jp-blue shadow-md transform scale-105' : 'bg-white/80 border-gray-100 text-gray-400']"
            >
                <span class="text-xs opacity-80">{{ day.date }}</span>
                <span class="text-lg font-bold">Day {{ index + 1 }}</span>
                <span class="text-xs font-light">({{ day.wd }})</span>
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 hide-scrollbar relative z-10 pb-24">
        
        <div v-show="currentTab === 'info'" class="space-y-5 animate-fade-in pt-2">
            
            <div class="relative h-64 rounded-3xl overflow-hidden shadow-xl group">
                <img src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e" alt="Okinawa" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent flex flex-col items-center justify-end pb-6 text-black text-center p-4">
                    <h1 class="text-3xl font-bold tracking-widest mb-1 drop-shadow-lg">OKINAWA</h1>
                    <p class="text-lg font-medium drop-shadow-md">沖繩家族旅行</p>
                    <div class="mt-2 text-xs bg-white/20 backdrop-blur-md border border-white/30 px-3 py-1 rounded-full font-mono">
                        2026/04/06 ~ 2026/04/11
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden relative">
                <div class="bg-jp-dark-gray text-black p-3 text-sm font-bold flex justify-between items-center">
                    <span><i class="fas fa-plane-departure mr-2"></i>航班資訊</span>
                    <span class="text-xs font-normal opacity-80">STARLUX 星宇航空</span>
                </div>
                <div class="p-4 border-b border-dashed border-gray-300 relative ticket-stub">
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-xs text-gray-400">2026/04/06 (一)</div>
                        <div class="text-xs font-bold text-jp-blue border border-jp-blue px-2 rounded">去程 JX870</div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-800">TPE</div>
                            <div class="text-xs text-gray-500">台北 T1</div>
                            <div class="text-lg font-mono font-bold text-jp-dark-gray mt-1">12:00</div>
                        </div>
                        <div class="text-gray-300"><i class="fas fa-arrow-right"></i></div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-800">OKA</div>
                            <div class="text-xs text-gray-500">沖繩 I</div>
                            <div class="text-lg font-mono font-bold text-jp-dark-gray mt-1">14:40</div>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-xs text-gray-400">2026/04/11 (六)</div>
                        <div class="text-xs font-bold text-jp-blue border border-jp-blue px-2 rounded">回程 JX871</div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-800">OKA</div>
                            <div class="text-xs text-gray-500">沖繩 I</div>
                            <div class="text-lg font-mono font-bold text-jp-dark-gray mt-1">15:50</div>
                        </div>
                        <div class="text-gray-300"><i class="fas fa-arrow-right"></i></div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-800">TPE</div>
                            <div class="text-xs text-gray-500">台北 T1</div>
                            <div class="text-lg font-mono font-bold text-jp-dark-gray mt-1">16:30</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-r from-blue-400 to-blue-500 text-black p-4 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold"><i class="fas fa-cloud-sun-rain mr-2"></i>天氣預報</h3>
                </div>
                <div class="flex space-x-4 overflow-x-auto hide-scrollbar pb-2">
                    <div v-for="(w, i) in weatherForecast" :key="i" class="flex-shrink-0 flex flex-col items-center w-14">
                        <span class="text-xs opacity-80">{{ w.date }}</span>
                        <i :class="w.icon" class="text-2xl my-2 text-yellow-300 drop-shadow-md"></i>
                        <span class="text-sm font-bold">{{ w.temp }}°</span>
                    </div>
                </div>
            </div>

            <div class="bg-white/90 rounded-2xl p-5 shadow-sm border border-gray-50 mb-10">
                <h3 class="font-bold text-pink-400 mb-3 text-sm tracking-wide border-b border-pink-100 pb-2">
                    <i class="fas fa-baby-carriage mr-2"></i>育嬰與親子熱點
                </h3>
                <ul class="space-y-3 text-sm text-gray-600">
                    <li class="flex flex-col"><span class="font-bold text-gray-700">AEON Mall Rycom</span><span class="text-xs text-gray-400">五星級育嬰室，熱水、尿布販賣機。</span></li>
                    <li class="flex flex-col"><span class="font-bold text-gray-700">美麗海水族館</span><span class="text-xs text-gray-400">全館無障礙，各樓層皆有哺乳室。</span></li>
                    <li class="flex flex-col"><span class="font-bold text-gray-700">浦添大公園</span><span class="text-xs text-gray-400">C區適合幼兒，有遮陽棚。</span></li>
                </ul>
            </div>
        </div>
        
        <div v-show="currentTab === 'schedule'" class="space-y-4 animate-fade-in">
            <div class="flex justify-between items-end mb-2">
                <h2 class="text-lg font-bold text-gray-600">Day {{ currentDayIndex + 1 }} 行程</h2>
                <button @click="openEditModal()" class="text-xs bg-jp-dark-gray text-black px-3 py-1.5 rounded-lg shadow hover:opacity-90">
                    <i class="fas fa-plus mr-1"></i>新增
                </button>
            </div>

            <div v-if="currentItinerary.length === 0" class="text-center py-10 text-gray-400 font-light bg-white/50 rounded-xl">
                <p>本日尚無行程</p>
            </div>

            <div v-for="(item, idx) in currentItinerary" :key="item.id" class="bg-jp-card/95 backdrop-blur-sm p-4 rounded-2xl shadow-sm border border-gray-50 relative group">
                <div class="flex justify-between items-start">
                    <div class="flex items-start gap-3">
                        <span class="text-lg font-bold text-jp-blue font-mono mt-0.5">{{ item.time }}</span>
                        <div>
                            <h3 class="font-bold text-gray-700 text-lg leading-tight">{{ item.location }}</h3>
                            <div class="text-xs text-gray-400 mt-1 flex items-center">
                                <i :class="getWeatherIcon(item.weather)" class="mr-1"></i> {{ item.weather }}
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-1 shrink-0">
                        <button @click="openMapLink(item)" class="text-blue-400 hover:text-blue-600 bg-blue-50 w-8 h-8 rounded-full flex items-center justify-center">
                            <i class="fas fa-location-arrow"></i>
                        </button>
                        <button @click="editItem(idx)" class="text-gray-300 hover:text-jp-primary pt-1">
                            <i class="fas fa-pen"></i>
                        </button>
                        <button @click="deleteItem(idx)" class="text-gray-300 hover:text-red-400 pt-1">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div v-if="item.note" class="mt-3 text-sm text-gray-600 bg-gray-50 p-2.5 rounded-lg ml-0 border-l-4 border-jp-blue">
                    {{ item.note }}
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'money'" class="space-y-4 animate-fade-in">
             <div class="bg-jp-dark-gray p-4 rounded-2xl shadow-md text-black relative overflow-hidden">
                <div class="absolute -right-6 -top-6 text-black/10 text-8xl"><i class="fas fa-wallet"></i></div>
                <h3 class="text-xs opacity-70 mb-1">旅程總支出 (TWD)</h3>
                <p class="text-2xl font-bold">$ {{ formatNumber(grandTotalTWD) }}</p>
            </div>

            <div class="bg-jp-card/90 p-4 rounded-2xl shadow-sm border border-gray-100 relative">
                <h3 class="text-sm text-gray-400 mb-1">Day {{ currentDayIndex + 1 }} 小計</h3>
                <div class="flex items-baseline gap-2">
                    <p class="text-2xl font-bold text-jp-blue">¥ {{ formatNumber(dailyTotalJPY) }}</p>
                    <p class="text-sm text-gray-400">(約 NT$ {{ formatNumber(dailyTotalTWD) }})</p>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm p-4 border border-gray-100">
                <div class="flex justify-between items-center mb-2 cursor-pointer" @click="showCalculator = !showCalculator">
                    <span class="text-sm font-bold text-gray-500"><i class="fas fa-calculator mr-2"></i>計算機</span>
                    <i class="fas" :class="showCalculator ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                </div>
                <div v-if="showCalculator">
                    <div class="bg-gray-100 rounded-xl p-2 text-right mb-3 h-12 flex flex-col justify-center">
                        <div class="text-xl font-mono font-bold text-gray-700 overflow-hidden">{{ calcDisplay || '0' }}</div>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <button @click="calcClear()" class="calc-btn bg-red-50 text-red-400 col-span-1">C</button>
                        <button @click="calcOp('/')" class="calc-btn bg-gray-100 text-jp-blue"><i class="fas fa-divide"></i></button>
                        <button @click="calcOp('*')" class="calc-btn bg-gray-100 text-jp-blue"><i class="fas fa-times"></i></button>
                        <button @click="calcOp('-')" class="calc-btn bg-gray-100 text-jp-blue"><i class="fas fa-minus"></i></button>
                        <button @click="calcAppend('7')" class="calc-btn bg-gray-50 text-gray-600">7</button>
                        <button @click="calcAppend('8')" class="calc-btn bg-gray-50 text-gray-600">8</button>
                        <button @click="calcAppend('9')" class="calc-btn bg-gray-50 text-gray-600">9</button>
                        <button @click="calcOp('+')" class="calc-btn bg-gray-100 text-jp-blue"><i class="fas fa-plus"></i></button>
                        <button @click="calcAppend('4')" class="calc-btn bg-gray-50 text-gray-600">4</button>
                        <button @click="calcAppend('5')" class="calc-btn bg-gray-50 text-gray-600">5</button>
                        <button @click="calcAppend('6')" class="calc-btn bg-gray-50 text-gray-600">6</button>
                        <button @click="calcResult()" class="calc-btn bg-jp-blue text-black shadow-md row-span-2">=</button>
                        <button @click="calcAppend('1')" class="calc-btn bg-gray-50 text-gray-600">1</button>
                        <button @click="calcAppend('2')" class="calc-btn bg-gray-50 text-gray-600">2</button>
                        <button @click="calcAppend('3')" class="calc-btn bg-gray-50 text-gray-600">3</button>
                        <button @click="calcAppend('0')" class="calc-btn bg-gray-50 text-gray-600 col-span-2">0</button>
                        <button @click="calcAppend('.')" class="calc-btn bg-gray-50 text-gray-600">.</button>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <button @click="fillExpense('JPY')" class="flex-1 py-2 text-xs text-jp-blue border border-jp-blue rounded-lg font-bold">填入日幣</button>
                        <button @click="fillExpense('TWD')" class="flex-1 py-2 text-xs text-gray-500 border border-gray-300 rounded-lg">填入台幣</button>
                    </div>
                </div>
            </div>

            <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                <h4 class="text-xs text-gray-400 mb-2 ml-1">Day {{ currentDayIndex + 1 }} 記一筆</h4>
                <div class="flex gap-2 items-center mb-2">
                    <input v-model="newExpense.item" type="text" placeholder="項目" class="flex-1 bg-gray-50 p-2 rounded-lg outline-none text-sm border border-gray-100">
                    <select v-model="newExpense.currency" class="bg-gray-50 p-2 rounded-lg outline-none text-sm text-gray-600 font-bold border border-gray-100">
                        <option value="JPY">¥ JPY</option>
                        <option value="TWD">$ TWD</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <input v-model="newExpense.amount" type="number" placeholder="金額" class="flex-1 bg-gray-50 p-2 rounded-lg outline-none text-sm font-mono border border-gray-100">
                    <button @click="addExpense" class="bg-jp-dark-gray text-black px-4 py-2 rounded-lg flex items-center justify-center shadow-sm hover:opacity-90"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div class="space-y-2 pb-4">
                 <div v-if="currentExpenses.length === 0" class="text-center py-4 text-gray-400 font-light text-sm">無紀錄</div>
                <div v-for="(exp, idx) in currentExpenses" :key="idx" class="flex justify-between items-center p-3 bg-white/95 rounded-xl border-l-4 border-gray-200 hover:border-jp-blue transition-colors shadow-sm">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div :class="['w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold shrink-0', exp.currency === 'JPY' ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700']">{{ exp.currency === 'JPY' ? '¥' : '$' }}</div>
                        <span class="text-gray-700 truncate">{{ exp.item }}</span>
                    </div>
                    <div class="flex items-center gap-3 shrink-0">
                        <div class="text-right">
                            <div class="text-sm font-bold text-gray-700 font-mono">{{ exp.currency === 'JPY' ? '¥' : 'NT$' }} {{ formatNumber(exp.amount) }}</div>
                            <div class="text-xs text-gray-400 font-mono">≈ {{ exp.currency === 'JPY' ? 'NT$' : '¥' }} {{ formatNumber(Math.round(exp.currency === 'JPY' ? exp.amount * exchangeRate : exp.amount / exchangeRate)) }}</div>
                        </div>
                        <button @click="deleteExpense(idx)" class="text-gray-300 hover:text-red-400 p-1"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <nav class="bg-white/95 backdrop-blur-md border-t border-gray-100 flex justify-around items-center h-20 pb-4 shrink-0 shadow-[0_-5px_20px_rgba(0,0,0,0.03)] z-30 fixed bottom-0 w-full max-w-[480px]">
        
        <button @click="switchTab('info')" :class="['flex flex-col items-center justify-center w-full h-full pt-2', currentTab === 'info' ? 'text-jp-blue' : 'text-gray-300']">
            <i class="fas fa-plane text-xl mb-1 transition-transform" :class="currentTab === 'info' ? 'scale-110' : ''"></i>
            <span class="text-[10px] font-medium">資訊</span>
        </button>

        <button @click="switchTab('schedule')" :class="['flex flex-col items-center justify-center w-full h-full pt-2', currentTab === 'schedule' ? 'text-jp-blue' : 'text-gray-300']">
            <i class="fas fa-calendar-alt text-xl mb-1 transition-transform" :class="currentTab === 'schedule' ? 'scale-110' : ''"></i>
            <span class="text-[10px] font-medium">行程</span>
        </button>
        
        <button @click="switchTab('money')" :class="['flex flex-col items-center justify-center w-full h-full pt-2', currentTab === 'money' ? 'text-jp-blue' : 'text-gray-300']">
            <i class="fas fa-wallet text-xl mb-1 transition-transform" :class="currentTab === 'money' ? 'scale-110' : ''"></i>
            <span class="text-[10px] font-medium">紀錄</span>
        </button>

    </nav>

    <div v-if="showModal" class="fixed inset-0 z-50 bg-black/40 backdrop-blur-[2px] flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:w-10/12 rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl transform transition-transform duration-300 max-w-[480px]">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
            <h3 class="text-lg font-bold mb-4 text-center text-gray-700">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
            <div class="space-y-4">
                <div class="flex gap-4">
                    <div class="w-1/3">
                        <label class="text-[10px] text-gray-400 font-bold ml-1 uppercase">Time</label>
                        <input v-model="form.time" type="time" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 ring-jp-blue/50 text-center">
                    </div>
                    <div class="w-2/3">
                        <label class="text-[10px] text-gray-400 font-bold ml-1 uppercase">Location</label>
                        <input v-model="form.location" type="text" placeholder="地點" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 ring-jp-blue/50">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 font-bold ml-1 uppercase">Google Maps Link</label>
                    <input v-model="form.mapLink" type="text" placeholder="網址 (可選)" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 ring-jp-blue/50 text-xs">
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 font-bold ml-1 uppercase">Notes</label>
                    <textarea v-model="form.note" rows="2" placeholder="備註..." class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 ring-jp-blue/50 resize-none"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button @click="closeModal" class="flex-1 py-3.5 rounded-xl bg-gray-100 text-gray-500 font-bold text-sm">取消</button>
                <button @click="saveEvent" class="flex-1 py-3.5 rounded-xl bg-jp-dark-gray text-black font-bold shadow-lg text-sm">確認</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, watch, onMounted } = Vue;

    createApp({
        setup() {
            // 預設 Tab 改為 info
            const currentTab = ref('info');
            const currentDayIndex = ref(0);
            const exchangeRate = ref(0.215); 
            
            const tripDates = [
                { date: '4/6', wd: '一' }, { date: '4/7', wd: '二' }, { date: '4/8', wd: '三' },
                { date: '4/9', wd: '四' }, { date: '4/10', wd: '五' }, { date: '4/11', wd: '六' }
            ];

            // 預設行程
            const defaultItineraries = {
                0: [
                    { id: 101, time: '12:00', location: '抵達沖繩那霸機場 (JX870)', note: '入境、取行李、取車', mapLink: '', weather: '晴時多雲' },
                    { id: 102, time: '15:00', location: '民宿 Check-in', note: '放置行李', mapLink: '', weather: '晴時多雲' },
                    { id: 103, time: '17:30', location: '美國村散步', note: '日落海灘看夕陽', mapLink: '', weather: '多雲' },
                    { id: 104, time: '19:00', location: '晚餐', note: '美國村內覓食', mapLink: '', weather: '多雲' }
                ],
                1: [
                    { id: 201, time: '09:00', location: '萬座毛', note: '看象鼻岩、拍照', mapLink: '', weather: '晴朗' },
                    { id: 202, time: '10:30', location: '備瀨福木林道', note: '散步或騎腳踏車', mapLink: '', weather: '晴朗' },
                    { id: 203, time: '12:00', location: '海人料理 海邦丸', note: '午餐：海鮮定食', mapLink: '', weather: '晴朗' },
                    { id: 204, time: '14:00', location: '美麗海水族館', note: '黑潮之海餵食秀', mapLink: '', weather: '晴朗' },
                    { id: 205, time: '16:30', location: '古宇利大橋', note: '開車兜風、沙灘散步', mapLink: '', weather: '多雲' },
                    { id: 206, time: '18:30', location: '阿古豬晚餐', note: '火鍋或燒肉(記得預約)', mapLink: '', weather: '多雲' },
                    { id: 207, time: '20:30', location: '回美國村', note: '休息', mapLink: '', weather: '多雲' }
                ],
                2: [
                    { id: 301, time: '09:30', location: '玉泉洞 / Okinawa World', note: '鐘乳石洞、王國村', mapLink: '', weather: '短暫雨' },
                    { id: 302, time: '12:30', location: '園區內午餐', note: '沖繩蕎麥麵', mapLink: '', weather: '陰天' },
                    { id: 303, time: '18:00', location: '晚餐: 火鍋/燒肉', note: '市區或美國村', mapLink: '', weather: '陰天' }
                ],
                3: [
                    { id: 401, time: '10:00', location: '普天滿宮', note: '參拜、地底神宮', mapLink: '', weather: '多雲時晴' },
                    { id: 402, time: '12:00', location: '港川外人住宅區', note: '找午餐、甜點(可麗露)', mapLink: '', weather: '多雲時晴' },
                    { id: 403, time: '15:00', location: '牧志公設市場', note: '吃點心、逛街', mapLink: '', weather: '晴朗' },
                    { id: 404, time: '18:00', location: '國際通晚餐', note: '鄉村料理、聽三線琴', mapLink: '', weather: '晴朗' }
                ],
                4: [
                    { id: 501, time: '11:00', location: 'AEON Mall Rycom', note: '全日購物行程 (來客夢)', mapLink: '', weather: '雨天' },
                    { id: 502, time: '18:00', location: '晚餐', note: 'Mall 內解決或超市熟食', mapLink: '', weather: '雨天' }
                ],
                5: [
                    { id: 601, time: '10:00', location: '波上宮', note: '最後參拜、海灘拍照', mapLink: '', weather: '晴朗' },
                    { id: 602, time: '13:00', location: '抵達那霸機場', note: '還車、逛免稅店', mapLink: '', weather: '晴朗' },
                    { id: 603, time: '15:50', location: '飛機起飛 (JX871)', note: '返回溫暖的家', mapLink: '', weather: '晴朗' }
                ]
            };

            const allItineraries = ref(defaultItineraries);
            const allExpenses = ref({ 0: [], 1: [], 2: [], 3: [], 4: [], 5: [] });
            
            // LocalStorage
            const STORAGE_KEY = 'okinawa_trip_2026_data_v2';
            
            const saveData = () => {
                const data = {
                    itineraries: allItineraries.value,
                    expenses: allExpenses.value,
                    rate: exchangeRate.value
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            };

            onMounted(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if(parsed.itineraries) allItineraries.value = parsed.itineraries;
                        if(parsed.expenses) allExpenses.value = parsed.expenses;
                        if(parsed.rate) exchangeRate.value = parsed.rate;
                    } catch(e) { console.error('Data load error', e); }
                }
            });

            watch([allItineraries, allExpenses, exchangeRate], saveData, { deep: true });

            const newExpense = ref({ item: '', amount: '', currency: 'JPY' });
            const showCalculator = ref(false);
            const calcDisplay = ref('');
            const showModal = ref(false);
            const isEditing = ref(false);
            const editingId = ref(null);
            const form = ref({ time: '', location: '', note: '', mapLink: '' });
            
            const weatherForecast = [
                { date: '4/6 (一)', icon: 'fas fa-cloud-sun', temp: '24', desc: '晴時多雲' },
                { date: '4/7 (二)', icon: 'fas fa-sun', temp: '26', desc: '晴朗' },
                { date: '4/8 (三)', icon: 'fas fa-cloud-showers-heavy', temp: '22', desc: '短暫雨' },
                { date: '4/9 (四)', icon: 'fas fa-cloud-sun', temp: '25', desc: '多雲時晴' },
                { date: '4/10 (五)', icon: 'fas fa-umbrella', temp: '21', desc: '雨天' },
                { date: '4/11 (六)', icon: 'fas fa-sun', temp: '27', desc: '晴朗' },
            ];

            const currentItinerary = computed(() => (allItineraries.value[currentDayIndex.value] || []).sort((a, b) => a.time.localeCompare(b.time)));
            const currentExpenses = computed(() => allExpenses.value[currentDayIndex.value] || []);
            const dailyTotalJPY = computed(() => currentExpenses.value.reduce((sum, item) => sum + (item.currency === 'JPY' ? Number(item.amount) : Number(item.amount) / exchangeRate.value), 0));
            const dailyTotalTWD = computed(() => Math.round(dailyTotalJPY.value * exchangeRate.value));
            const grandTotalTWD = computed(() => {
                let totalJPY = 0;
                Object.values(allExpenses.value).forEach(d => d.forEach(item => totalJPY += item.currency === 'JPY' ? Number(item.amount) : Number(item.amount) / exchangeRate.value));
                return Math.round(totalJPY * exchangeRate.value);
            });

            const formatNumber = (num) => num.toFixed(0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            const switchTab = (tab) => currentTab.value = tab;
            const selectDay = (index) => currentDayIndex.value = index;
            const openEditModal = () => { isEditing.value = false; form.value = { time: '12:00', location: '', note: '', mapLink: '' }; showModal.value = true; };
            const editItem = (index) => { form.value = { ...currentItinerary.value[index] }; isEditing.value = true; editingId.value = index; showModal.value = true; };
            const saveEvent = () => {
                if (!form.value.location) return alert('請輸入地點');
                const dayWeather = weatherForecast[currentDayIndex.value].desc;
                if (isEditing.value) { allItineraries.value[currentDayIndex.value][editingId.value] = { ...form.value, weather: dayWeather }; } 
                else { allItineraries.value[currentDayIndex.value].push({ id: Date.now(), ...form.value, weather: dayWeather }); }
                closeModal();
            };
            const deleteItem = (index) => { if(confirm('刪除此行程?')) allItineraries.value[currentDayIndex.value].splice(index, 1); };
            const closeModal = () => showModal.value = false;
            const openMapLink = (item) => { window.open(item.mapLink || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location + ' 沖繩')}`, '_blank'); };
            const getWeatherIcon = (w) => { if(w.includes('雨')) return 'fas fa-umbrella text-blue-400'; if(w.includes('晴')) return 'fas fa-sun text-orange-400'; return 'fas fa-cloud text-gray-400'; };

            const addExpense = () => {
                if(!newExpense.value.item || !newExpense.value.amount) return alert("輸入不完整");
                allExpenses.value[currentDayIndex.value].unshift({ ...newExpense.value });
                newExpense.value = { item: '', amount: '', currency: 'JPY' };
            };
            const deleteExpense = (index) => { if(confirm('刪除此帳務?')) allExpenses.value[currentDayIndex.value].splice(index, 1); }
            
            const calcAppend = (c) => calcDisplay.value += c;
            const calcClear = () => calcDisplay.value = '';
            const calcOp = (op) => calcDisplay.value += op;
            const calcResult = () => { try { calcDisplay.value = eval(calcDisplay.value).toString(); } catch (e) { calcDisplay.value = 'Error'; } };
            const fillExpense = (curr) => { 
                const val = parseFloat(calcDisplay.value); 
                if(!isNaN(val)) { newExpense.value.amount = Math.round(val); newExpense.value.currency = curr; } 
            };

            return {
                currentTab, switchTab, tripDates, currentDayIndex, selectDay,
                currentItinerary, showModal, isEditing, form, openEditModal, editItem, saveEvent, deleteItem, closeModal, openMapLink, getWeatherIcon, weatherForecast,
                currentExpenses, newExpense, addExpense, deleteExpense, dailyTotalJPY, dailyTotalTWD, grandTotalTWD, exchangeRate, formatNumber, saveData,
                showCalculator, calcDisplay, calcAppend, calcClear, calcOp, calcResult, fillExpense
            };
        }
    }).mount('#app');
</script>
</body>
</html>
