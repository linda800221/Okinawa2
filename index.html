<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>沖繩旅人 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-bg': '#F9F8F4',       /* 極簡米白背景 */
                        'jp-card': '#FFFFFF',     /* 卡片白 */
                        'jp-primary': '#E3D7A3',  /* 淡黃/亞麻色主色 */
                        'jp-text': '#595959',     /* 深灰文字 */
                        'jp-accent': '#C9B874',   /* 深一點的黃色強調 */
                        'jp-soft-gray': '#F2F2F2',
                        'jp-dark-gray': '#4A4A4A',
                        'jp-blue': '#A5C9CA',     /* 海洋藍 */
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* 隱藏 Scrollbar */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        body { background-color: #eee; }
        .app-container {
            max-width: 480px; 
            margin: 0 auto;
            background-color: #F9F8F4;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        /* 背景鯨鯊裝飾 (CSS繪製極簡風) */
        .whale-shark-bg {
            position: absolute;
            top: -50px;
            right: -80px;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, var(--jp-blue) 0%, transparent 70%);
            opacity: 0.15;
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
        }
        .whale-shark-shape {
            position: absolute;
            top: 60px;
            right: 20px;
            font-size: 120px;
            color: var(--jp-blue);
            opacity: 0.08;
            transform: rotate(-20deg);
            pointer-events: none;
            z-index: 0;
        }
        
        /* 計算機按鈕樣式 */
        .calc-btn {
            @apply rounded-xl text-lg font-bold transition-all active:scale-95 shadow-sm flex items-center justify-center h-12 border border-gray-100;
        }
    </style>
</head>
<body>

<div id="app" class="app-container text-jp-text">

    <div class="whale-shark-bg"></div>
    <i class="fas fa-fish whale-shark-shape"></i>

    <header class="bg-jp-bg/80 backdrop-blur-sm pt-6 pb-2 px-4 shadow-sm z-20 shrink-0 relative">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center">
                <h1 class="text-xl font-bold tracking-widest text-jp-dark-gray mr-2">
                    <span class="text-jp-blue">沖繩</span> OKINAWA <span class="text-xs font-normal hidden sm:inline">2026</span>
                </h1>
                <p class="text-xs text-gray-400 sm:hidden">4/6 - 4/11</p>
            </div>
            <div class="text-xs bg-jp-primary text-white pl-3 pr-1 py-1 rounded-full shadow-sm flex items-center">
                匯率: <input type="number" step="0.001" v-model="exchangeRate" class="w-12 bg-transparent border-b border-white/50 text-center focus:outline-none ml-1 text-white font-bold">
            </div>
        </div>

        <div class="flex space-x-3 overflow-x-auto hide-scrollbar pb-2 px-1 relative z-30">
            <button 
                v-for="(day, index) in tripDates" 
                :key="index"
                @click="selectDay(index)"
                :class="['flex-shrink-0 w-16 h-18 py-2 rounded-xl flex flex-col items-center justify-center transition-all duration-300 border', 
                currentDayIndex === index ? 'bg-jp-primary text-white border-jp-primary shadow-md transform scale-105' : 'bg-white/80 border-gray-100 text-gray-400']"
            >
                <span class="text-xs opacity-80">{{ day.date }}</span>
                <span class="text-lg font-bold">Day {{ index + 1 }}</span>
                <span class="text-xs font-light">({{ day.wd }})</span>
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 hide-scrollbar relative z-10 pb-24">
        
        <div v-show="currentTab === 'schedule'" class="space-y-4 animate-fade-in">
            <div class="flex justify-between items-end mb-2">
                <h2 class="text-lg font-bold text-gray-600">Day {{ currentDayIndex + 1 }} 行程</h2>
                <button @click="openEditModal()" class="text-xs bg-jp-dark-gray text-white px-3 py-1.5 rounded-lg shadow hover:opacity-90">
                    <i class="fas fa-plus mr-1"></i>新增
                </button>
            </div>

            <div v-if="currentItinerary.length === 0" class="text-center py-10 text-gray-400 font-light">
                <p>本日尚無行程</p>
            </div>

            <div v-for="(item, idx) in currentItinerary" :key="item.id" class="bg-jp-card p-4 rounded-2xl shadow-sm border border-gray-50 relative group">
                <div class="flex justify-between items-start">
                    <div class="flex items-start gap-3">
                        <span class="text-lg font-bold text-jp-accent font-mono mt-0.5">{{ item.time }}</span>
                        <div>
                            <h3 class="font-bold text-gray-700 text-lg leading-tight">{{ item.location }}</h3>
                            <div class="text-xs text-gray-400 mt-1 flex items-center">
                                <i :class="getWeatherIcon(item.weather)" class="mr-1"></i> {{ item.weather }}
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-1 shrink-0">
                        <button @click="openMapLink(item)" class="text-blue-400 hover:text-blue-600 bg-blue-50 w-8 h-8 rounded-full flex items-center justify-center">
                            <i class="fas fa-location-arrow"></i>
                        </button>
                        <button @click="editItem(idx)" class="text-gray-300 hover:text-jp-primary pt-1">
                            <i class="fas fa-pen"></i>
                        </button>
                        <button @click="deleteItem(idx)" class="text-gray-300 hover:text-red-400 pt-1">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div v-if="item.note" class="mt-3 text-sm text-gray-600 bg-jp-soft-gray p-2.5 rounded-lg ml-0 border-l-4 border-jp-primary">
                    {{ item.note }}
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'money'" class="space-y-4 animate-fade-in">
            
            <div class="bg-jp-dark-gray p-4 rounded-2xl shadow-md text-white relative overflow-hidden">
                <div class="absolute -right-6 -top-6 text-white/10 text-8xl"><i class="fas fa-wallet"></i></div>
                <h3 class="text-xs opacity-70 mb-1">整趟旅程總支出 (估算)</h3>
                <p class="text-2xl font-bold">NT$ {{ formatNumber(grandTotalTWD) }}</p>
            </div>

            <div class="bg-jp-card p-5 rounded-2xl shadow-sm border border-jp-primary/30 relative overflow-hidden">
                <div class="absolute right-0 top-0 w-20 h-20 bg-jp-primary/10 rounded-bl-full -mr-4 -mt-4"></div>
                <h3 class="text-sm text-gray-400 mb-1">Day {{ currentDayIndex + 1 }} 支出總計</h3>
                <div class="flex items-baseline gap-2">
                    <p class="text-3xl font-bold text-jp-accent">¥ {{ formatNumber(dailyTotalJPY) }}</p>
                    <p class="text-sm text-gray-400">(約 NT$ {{ formatNumber(dailyTotalTWD) }})</p>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm p-4 border border-gray-100">
                <div class="flex justify-between items-center mb-2 cursor-pointer" @click="showCalculator = !showCalculator">
                    <span class="text-sm font-bold text-gray-500"><i class="fas fa-calculator mr-2"></i>計算機</span>
                    <i class="fas" :class="showCalculator ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                </div>
                
                <div v-if="showCalculator">
                    <div class="bg-gray-100 rounded-xl p-2 text-right mb-3 h-12 flex flex-col justify-center">
                        <div class="text-xl font-mono font-bold text-gray-700 overflow-hidden">{{ calcDisplay || '0' }}</div>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <button @click="calcClear()" class="calc-btn bg-red-50 text-red-400 col-span-1">C</button>
                        <button @click="calcOp('/')" class="calc-btn bg-gray-100 text-jp-primary"><i class="fas fa-divide"></i></button>
                        <button @click="calcOp('*')" class="calc-btn bg-gray-100 text-jp-primary"><i class="fas fa-times"></i></button>
                        <button @click="calcOp('-')" class="calc-btn bg-gray-100 text-jp-primary"><i class="fas fa-minus"></i></button>

                        <button @click="calcAppend('7')" class="calc-btn bg-gray-50 text-gray-600">7</button>
                        <button @click="calcAppend('8')" class="calc-btn bg-gray-50 text-gray-600">8</button>
                        <button @click="calcAppend('9')" class="calc-btn bg-gray-50 text-gray-600">9</button>
                        <button @click="calcOp('+')" class="calc-btn bg-gray-100 text-jp-primary"><i class="fas fa-plus"></i></button>
                        
                        <button @click="calcAppend('4')" class="calc-btn bg-gray-50 text-gray-600">4</button>
                        <button @click="calcAppend('5')" class="calc-btn bg-gray-50 text-gray-600">5</button>
                        <button @click="calcAppend('6')" class="calc-btn bg-gray-50 text-gray-600">6</button>
                        <button @click="calcResult()" class="calc-btn bg-jp-primary text-white shadow-md row-span-2">=</button>

                        <button @click="calcAppend('1')" class="calc-btn bg-gray-50 text-gray-600">1</button>
                        <button @click="calcAppend('2')" class="calc-btn bg-gray-50 text-gray-600">2</button>
                        <button @click="calcAppend('3')" class="calc-btn bg-gray-50 text-gray-600">3</button>
                        
                        <button @click="calcAppend('0')" class="calc-btn bg-gray-50 text-gray-600 col-span-2">0</button>
                        <button @click="calcAppend('.')" class="calc-btn bg-gray-50 text-gray-600">.</button>
                    </div>
                     <div class="flex gap-2 mt-3">
                        <button @click="fillExpense('JPY')" class="flex-1 py-2 text-xs text-jp-primary border border-jp-primary rounded-lg hover:bg-jp-primary/10">
                            填入日幣
                        </button>
                        <button @click="fillExpense('TWD')" class="flex-1 py-2 text-xs text-gray-500 border border-gray-300 rounded-lg hover:bg-gray-50">
                            填入台幣
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                <h4 class="text-xs text-gray-400 mb-2 ml-1">新增 Day {{ currentDayIndex + 1 }} 支出</h4>
                <div class="flex gap-2 items-center mb-2">
                    <input v-model="newExpense.item" type="text" placeholder="消費項目 (如: 午餐)" class="flex-1 bg-gray-50 p-2 rounded-lg outline-none text-sm focus:ring-1 ring-jp-primary">
                    <select v-model="newExpense.currency" class="bg-gray-50 p-2 rounded-lg outline-none text-sm focus:ring-1 ring-jp-primary text-gray-600 font-bold">
                        <option value="JPY">¥ JPY</option>
                        <option value="TWD">$ TWD</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <input v-model="newExpense.amount" type="number" placeholder="金額" class="flex-1 bg-gray-50 p-2 rounded-lg outline-none text-sm focus:ring-1 ring-jp-primary font-mono">
                    <button @click="addExpense" class="bg-jp-dark-gray text-white px-4 py-2 rounded-lg flex items-center justify-center shadow-sm hover:opacity-90">
                        <i class="fas fa-plus mr-1"></i> 記一筆
                    </button>
                </div>
            </div>

            <div class="space-y-2 pb-4">
                 <div v-if="currentExpenses.length === 0" class="text-center py-4 text-gray-400 font-light text-sm">
                    本日尚未記帳
                </div>
                <div v-for="(exp, idx) in currentExpenses" :key="idx" class="flex justify-between items-center p-3 bg-white rounded-xl border-l-4 border-gray-200 hover:border-jp-accent transition-colors shadow-sm">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div :class="['w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold shrink-0', exp.currency === 'JPY' ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700']">
                            {{ exp.currency === 'JPY' ? '¥' : '$' }}
                        </div>
                        <span class="text-gray-700 truncate">{{ exp.item }}</span>
                    </div>
                    <div class="flex items-center gap-3 shrink-0">
                        <div class="text-right">
                            <div class="text-sm font-bold text-gray-700 font-mono">
                                {{ exp.currency === 'JPY' ? '¥' : 'NT$' }} {{ formatNumber(exp.amount) }}
                            </div>
                            <div class="text-xs text-gray-400 font-mono">
                                ≈ {{ exp.currency === 'JPY' ? 'NT$' : '¥' }} 
                                {{ formatNumber(Math.round(exp.currency === 'JPY' ? exp.amount * exchangeRate : exp.amount / exchangeRate)) }}
                            </div>
                        </div>
                        <button @click="deleteExpense(idx)" class="text-gray-300 hover:text-red-400 p-1">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'info'" class="space-y-4 animate-fade-in">
            
            <div class="bg-gradient-to-br from-blue-400 to-jp-blue text-white p-4 rounded-2xl shadow-lg shadow-blue-200/50">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold"><i class="fas fa-cloud-sun-rain mr-2"></i>沖繩天氣預報</h3>
                    <span class="text-xs bg-white/20 px-2 py-0.5 rounded">2026/4/6 - 4/11</span>
                </div>
                <div class="flex space-x-4 overflow-x-auto hide-scrollbar pb-2">
                    <div v-for="(w, i) in weatherForecast" :key="i" class="flex-shrink-0 flex flex-col items-center w-14">
                        <span class="text-xs opacity-80">{{ w.date }}</span>
                        <i :class="w.icon" class="text-2xl my-2 text-yellow-300 drop-shadow-md"></i>
                        <span class="text-sm font-bold">{{ w.temp }}°</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-50">
                <h3 class="font-bold text-pink-400 mb-3 text-sm tracking-wide border-b border-pink-100 pb-2">
                    <i class="fas fa-baby-carriage mr-2"></i>育嬰與親子熱點
                </h3>
                <ul class="space-y-3 text-sm text-gray-600">
                    <li class="flex flex-col"><span class="font-bold text-gray-700">AEON Mall Rycom</span><span class="text-xs text-gray-400">五星級育嬰室，設施最齊全。</span></li>
                    <li class="flex flex-col"><span class="font-bold text-gray-700">美麗海水族館</span><span class="text-xs text-gray-400">全館無障礙，各樓層皆有哺乳室。</span></li>
                </ul>
            </div>
        </div>

    </main>

    <nav class="bg-white/90 backdrop-blur-md border-t border-gray-100 flex justify-around items-center h-20 pb-4 shrink-0 shadow-[0_-5px_20px_rgba(0,0,0,0.03)] z-30 fixed bottom-0 w-full max-w-[480px]">
        <button @click="switchTab('schedule')" :class="['flex flex-col items-center justify-center w-full h-full pt-2', currentTab === 'schedule' ? 'text-jp-dark-gray' : 'text-gray-300']">
            <i class="fas fa-calendar-alt text-xl mb-1 transition-transform" :class="currentTab === 'schedule' ? 'scale-110' : ''"></i>
            <span class="text-[10px] font-medium">行程</span>
        </button>
        <button @click="switchTab('money')" :class="['flex flex-col items-center justify-center w-full h-full pt-2', currentTab === 'money' ? 'text-jp-dark-gray' : 'text-gray-300']">
            <i class="fas fa-wallet text-xl mb-1 transition-transform" :class="currentTab === 'money' ? 'scale-110' : ''"></i>
            <span class="text-[10px] font-medium">記帳</span>
        </button>
        <button @click="switchTab('info')" :class="['flex flex-col items-center justify-center w-full h-full pt-2', currentTab === 'info' ? 'text-jp-dark-gray' : 'text-gray-300']">
            <i class="fas fa-info-circle text-xl mb-1 transition-transform" :class="currentTab === 'info' ? 'scale-110' : ''"></i>
            <span class="text-[10px] font-medium">資訊</span>
        </button>
    </nav>

    <div v-if="showModal" class="fixed inset-0 z-50 bg-black/40 backdrop-blur-[2px] flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:w-10/12 rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl transform transition-transform duration-300 max-w-[480px]">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
            <h3 class="text-lg font-bold mb-4 text-center text-gray-700">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
            <div class="space-y-4">
                <div class="flex gap-4">
                    <div class="w-1/3">
                        <label class="text-[10px] text-gray-400 font-bold ml-1 uppercase">Time</label>
                        <input v-model="form.time" type="time" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 ring-jp-primary/50 text-center">
                    </div>
                    <div class="w-2/3">
                        <label class="text-[10px] text-gray-400 font-bold ml-1 uppercase">Location</label>
                        <input v-model="form.location" type="text" placeholder="輸入地點..." class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 ring-jp-primary/50">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 font-bold ml-1 uppercase">Google Maps Link (Optional)</label>
                    <input v-model="form.mapLink" type="text" placeholder="貼上 Google Maps 網址" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 ring-jp-primary/50 text-xs">
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 font-bold ml-1 uppercase">Notes</label>
                    <textarea v-model="form.note" rows="2" placeholder="備註事項..." class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 ring-jp-primary/50 resize-none"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button @click="closeModal" class="flex-1 py-3.5 rounded-xl bg-gray-100 text-gray-500 font-bold text-sm">取消</button>
                <button @click="saveEvent" class="flex-1 py-3.5 rounded-xl bg-jp-dark-gray text-white font-bold shadow-lg shadow-gray-400/30 text-sm">
                    {{ isEditing ? '儲存' : '新增' }}
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed } = Vue;

    createApp({
        setup() {
            const currentTab = ref('schedule');
            const currentDayIndex = ref(0);
            const exchangeRate = ref(0.215); // 可即時修改
            
            const tripDates = [
                { date: '4/6', wd: '一' }, { date: '4/7', wd: '二' }, { date: '4/8', wd: '三' },
                { date: '4/9', wd: '四' }, { date: '4/10', wd: '五' }, { date: '4/11', wd: '六' }
            ];

            // --- 行程資料 ---
            const allItineraries = ref({
                0: [
                    { id: 101, time: '13:00', location: '抵達沖繩那霸機場', note: '取車、買豬肉蛋飯糰', mapLink: '', weather: '晴時多雲' },
                    { id: 102, time: '15:00', location: '民宿 Check-in', note: '放置行李', mapLink: '', weather: '晴時多雲' },
                    { id: 103, time: '17:30', location: '美國村散步', note: '日落海灘看夕陽', mapLink: '', weather: '多雲' }
                ],
                1: [
                    { id: 201, time: '09:00', location: '萬座毛', note: '象鼻岩拍照', mapLink: '', weather: '晴朗' },
                    { id: 203, time: '12:00', location: '海人料理 海邦丸', note: '午餐海鮮', mapLink: '', weather: '晴朗' },
                    { id: 204, time: '14:00', location: '美麗海水族館', note: '黑潮之海', mapLink: '', weather: '晴朗' }
                ],
                2: [ { id: 301, time: '09:30', location: '玉泉洞 / Okinawa World', note: '', mapLink: '', weather: '短暫雨' } ],
                3: [ { id: 401, time: '15:00', location: '牧志公設市場', note: '', mapLink: '', weather: '晴朗' } ],
                4: [ { id: 501, time: '11:00', location: 'AEON Mall Rycom', note: '購物日', mapLink: '', weather: '雨天' } ],
                5: [ { id: 601, time: '11:30', location: '前往機場', note: '還車', mapLink: '', weather: '晴朗' } ]
            });

            // --- 記帳資料 (結構改變：按天分類) ---
            const allExpenses = ref({
                0: [ // Day 1 預設資料
                    { item: 'Lawson 炸雞', amount: 800, currency: 'JPY' },
                    { item: '租車尾款', amount: 15000, currency: 'JPY' }
                ],
                1: [], 2: [], 3: [], 4: [], 5: []
            });
            const newExpense = ref({ item: '', amount: '', currency: 'JPY' });
            const showCalculator = ref(false);
            const calcDisplay = ref('');

            // --- Modal & Other ---
            const showModal = ref(false);
            const isEditing = ref(false);
            const editingId = ref(null);
            const form = ref({ time: '', location: '', note: '', mapLink: '' });
            const weatherForecast = [ /* (省略相同資料以節省空間) */ 
                { date: '4/6 (一)', icon: 'fas fa-cloud-sun', temp: '24', desc: '晴時多雲' },
                { date: '4/7 (二)', icon: 'fas fa-sun', temp: '26', desc: '晴朗' },
                { date: '4/8 (三)', icon: 'fas fa-cloud-showers-heavy', temp: '22', desc: '短暫雨' },
                { date: '4/9 (四)', icon: 'fas fa-cloud-sun', temp: '25', desc: '多雲時晴' },
                { date: '4/10 (五)', icon: 'fas fa-umbrella', temp: '21', desc: '雨天' },
                { date: '4/11 (六)', icon: 'fas fa-sun', temp: '27', desc: '晴朗' },
            ];

            // --- Computed ---
            const currentItinerary = computed(() => {
                let list = allItineraries.value[currentDayIndex.value] || [];
                return list.sort((a, b) => a.time.localeCompare(b.time));
            });

            // 記帳相關 Computed
            const currentExpenses = computed(() => allExpenses.value[currentDayIndex.value] || []);
            
            // 計算本日 JPY 總和 (包含 TWD 換算過來的)
            const dailyTotalJPY = computed(() => {
                return currentExpenses.value.reduce((sum, item) => {
                    let amountInJPY = item.currency === 'JPY' ? Number(item.amount) : Number(item.amount) / exchangeRate.value;
                    return sum + amountInJPY;
                }, 0);
            });
            // 計算本日 TWD 總和
            const dailyTotalTWD = computed(() => Math.round(dailyTotalJPY.value * exchangeRate.value));

            // 計算整趟旅程 TWD 總和
            const grandTotalTWD = computed(() => {
                let totalJPY = 0;
                Object.values(allExpenses.value).forEach(dayExpenses => {
                    dayExpenses.forEach(item => {
                         totalJPY += item.currency === 'JPY' ? Number(item.amount) : Number(item.amount) / exchangeRate.value;
                    });
                });
                return Math.round(totalJPY * exchangeRate.value);
            });


            // --- Methods ---
            const formatNumber = (num) => num.toFixed(0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            const switchTab = (tab) => currentTab.value = tab;
            const selectDay = (index) => currentDayIndex.value = index;

            // 行程 CRUD (維持不變)
            const openEditModal = () => { isEditing.value = false; form.value = { time: '12:00', location: '', note: '', mapLink: '' }; showModal.value = true; };
            const editItem = (index) => { form.value = { ...currentItinerary.value[index] }; isEditing.value = true; editingId.value = index; showModal.value = true; };
            const saveEvent = () => {
                if (!form.value.location) return alert('請輸入地點');
                const dayWeather = weatherForecast[currentDayIndex.value].desc;
                if (isEditing.value) { allItineraries.value[currentDayIndex.value][editingId.value] = { ...form.value, weather: dayWeather }; } 
                else { allItineraries.value[currentDayIndex.value].push({ id: Date.now(), ...form.value, weather: dayWeather }); }
                closeModal();
            };
            const deleteItem = (index) => { if(confirm('確定刪除行程?')) allItineraries.value[currentDayIndex.value].splice(index, 1); };
            const closeModal = () => showModal.value = false;
            const openMapLink = (item) => { window.open(item.mapLink || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location + ' 沖繩')}`, '_blank'); };
            const getWeatherIcon = (w) => { if(w.includes('雨')) return 'fas fa-umbrella text-blue-400'; if(w.includes('晴')) return 'fas fa-sun text-orange-400'; return 'fas fa-cloud text-gray-400'; };

            // --- 記帳方法 (新) ---
            const addExpense = () => {
                if(!newExpense.value.item || !newExpense.value.amount) return alert("請輸入項目與金額");
                // 加入到「目前選擇的天數」
                allExpenses.value[currentDayIndex.value].unshift({ ...newExpense.value });
                newExpense.value = { item: '', amount: '', currency: 'JPY' }; // 重置並預設回 JPY
            };
            const deleteExpense = (index) => {
                if(confirm('確定刪除這筆帳務?')) {
                    allExpenses.value[currentDayIndex.value].splice(index, 1);
                }
            }

            // --- 計算機方法 (更新) ---
            const calcAppend = (char) => calcDisplay.value += char;
            const calcClear = () => calcDisplay.value = '';
            const calcOp = (op) => calcDisplay.value += op; // 直接附加運算符號
            const calcResult = () => {
                try { calcDisplay.value = eval(calcDisplay.value).toString(); } catch (e) { calcDisplay.value = 'Error'; }
            };
            const fillExpense = (curr) => {
                const val = parseFloat(calcDisplay.value);
                if(!isNaN(val)) {
                    newExpense.value.amount = Math.round(val);
                    newExpense.value.currency = curr; // 設定幣別
                }
            };

            return {
                currentTab, switchTab, tripDates, currentDayIndex, selectDay,
                currentItinerary, showModal, isEditing, form, openEditModal, editItem, saveEvent, deleteItem, closeModal, openMapLink, getWeatherIcon, weatherForecast,
                // 記帳相關
                currentExpenses, newExpense, addExpense, deleteExpense, 
                dailyTotalJPY, dailyTotalTWD, grandTotalTWD, exchangeRate, formatNumber,
                // 計算機相關
                showCalculator, calcDisplay, calcAppend, calcClear, calcOp, calcResult, fillExpense
            };
        }
    }).mount('#app');
</script>

</body>
</html>
